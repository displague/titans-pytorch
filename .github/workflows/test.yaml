name: Tests the examples in README
on: [push, pull_request]

env:
  TYPECHECK: True

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install uv
          python -m uv pip install --upgrade pip
          python -m uv pip install torch --index-url https://download.pytorch.org/whl/nightly/cpu
          python -m uv pip install -e .[test]
      - name: Test with pytest
        run: |
          python -m pytest tests/
      - name: Run lightweight benchmark regression check
        run: |
          python benchmarks/benchmark_symplectic.py --dim 64 --seq-len 64 --batch-size 2 --chunk-size 16 --long-seq-len 256 --long-warmup-steps 6 --long-perturb-steps 4 --long-recovery-steps 4 --output-json benchmarks/results/symplectic_ci_latest.json
          python benchmarks/benchmark_codebook_transfer.py --dim 64 --seq-len 96 --batch-size 2 --chunk-size 16 --long-seq-len 256 --long-warmup-steps 6 --long-perturb-steps 4 --long-recovery-steps 4 --interference-steps 6 --interference-eval-iters 4 --output-json benchmarks/results/codebook_transfer_ci_latest.json
          python benchmarks/check_regression.py --baseline benchmarks/results/symplectic_baseline.json --latest benchmarks/results/symplectic_ci_latest.json --codebook-baseline benchmarks/results/codebook_transfer_baseline.json --codebook-latest benchmarks/results/codebook_transfer_ci_latest.json
